<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:WordLens.ViewModels"
        xmlns:views="using:WordLens.Views"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:conv="using:WordLens.Converter"
        mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="550"
        x:Class="WordLens.Views.MainWindowView"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="WordLens - 设置"
        Width="700" Height="550"
        MinWidth="600" MinHeight="450"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="*,Auto" Margin="0">
        <!-- 主内容区域 -->
        <TabControl Grid.Row="0" Margin="10" x:Name="SettingsTabControl">
            <!-- 常规设置标签页 -->
            <TabItem Header="常规">
                <ScrollViewer>
                    <StackPanel Spacing="16" Margin="20" DataContext="{Binding SettingsViewModel}">
                        <!-- 应用界面语言 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="界面语言" FontWeight="Bold" FontSize="14" />
                            <ComboBox ItemsSource="{Binding AvailableUILanguages}"
                                      SelectedValue="{Binding UiLanguage}"
                                      SelectedValueBinding="{Binding Code}"
                                      DisplayMemberBinding="{Binding DisplayName}"
                                      Width="300"
                                      HorizontalAlignment="Left" />
                            <TextBlock Text="选择应用界面显示语言（翻译语言请在翻译窗口中选择）"
                                       FontSize="12"
                                       Opacity="0.6" />
                        </StackPanel>

                        <Separator />

                        <!-- 快捷键设置 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="快捷键" FontWeight="Bold" FontSize="14" />
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBox Text="{Binding HotkeyDisplay}"
                                         IsReadOnly="True"
                                         Width="200"
                                         VerticalContentAlignment="Center" />
                                <Button Content="设置快捷键"
                                        Command="{Binding StartCaptureHotkeyCommand}"
                                        CommandParameter="text"
                                        IsEnabled="{Binding !IsCapturingHotkey}"
                                        MinWidth="100" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBox Text="{Binding OcrHotkeyDisplay}"
                                         IsReadOnly="True"
                                         Width="200"
                                         VerticalContentAlignment="Center" />
                                <Button Content="设置OCR快捷键"
                                        Command="{Binding StartCaptureHotkeyCommand}"
                                        CommandParameter="ocr"
                                        IsEnabled="{Binding !IsCapturingHotkey}"
                                        MinWidth="100" />
                            </StackPanel>
                            <TextBlock IsVisible="{Binding IsCapturingHotkey}"
                                       Text="请按下想要设置的快捷键组合（按 ESC 取消）"
                                       FontSize="12"
                                       Foreground="Orange"
                                       FontWeight="Bold" />
                            <TextBlock IsVisible="{Binding !IsCapturingHotkey}"
                                       Text="点击按钮后按下想要设置的快捷键组合"
                                       FontSize="12"
                                       Opacity="0.6" />
                        </StackPanel>

                        <Separator />

                        <!-- 流式输出设置 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="流式输出" FontWeight="Bold" FontSize="14" />
                            
                            <CheckBox Content="启用流式输出（实时显示翻译结果）"
                                      IsChecked="{Binding StreamingEnabled}"
                                      ToolTip.Tip="启用后翻译内容将实时逐步显示，提供更好的用户体验" />
                            
                            <StackPanel Spacing="12"
                                        IsEnabled="{Binding StreamingEnabled}"
                                        Margin="24,8,0,0"
                                        Opacity="{Binding StreamingEnabled, Converter={x:Static conv:BoolToOpacityConverter.BoolToOpacityValueConverter}}">
                                
                                <!-- 打字机效果延迟 -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="打字机效果延迟（毫秒）" FontSize="13" />
                                    <NumericUpDown Value="{Binding TypewriterDelayMs}"
                                                   Minimum="0"
                                                   Maximum="200"
                                                   Increment="10"
                                                   Width="200"
                                                   HorizontalAlignment="Left"
                                                   ToolTip.Tip="每个字符显示之间的延迟时间" />
                                    <TextBlock Text="0 = 无延迟，实时显示；推荐值：30-50毫秒"
                                               FontSize="11"
                                               Opacity="0.6"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                                
                                <!-- 每次显示字符数 -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="每次显示字符数" FontSize="13" />
                                    <NumericUpDown Value="{Binding CharsPerUpdate}"
                                                   Minimum="1"
                                                   Maximum="10"
                                                   Increment="1"
                                                   Width="200"
                                                   HorizontalAlignment="Left"
                                                   ToolTip.Tip="一次性显示的字符数量" />
                                    <TextBlock Text="1 = 逐字显示；较大值可加快显示速度"
                                               FontSize="11"
                                               Opacity="0.6"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                            </StackPanel>
                            
                            <TextBlock Text="提示：流式输出可以让翻译过程更加流畅，但如果网络不稳定可以关闭此功能"
                                       FontSize="11"
                                       Opacity="0.6"
                                       TextWrapping="Wrap"
                                       Margin="0,4,0,0" />
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- 翻译源管理标签页 -->
            <TabItem Header="翻译源">
                <Grid ColumnDefinitions="*,Auto" Margin="10" DataContext="{Binding SettingsViewModel}">
                    <!-- 左侧列表 -->
                    <ListBox Grid.Column="0"
                             ItemsSource="{Binding Providers}"
                             SelectedItem="{Binding SelectedProvider}"
                             Margin="0,0,10,0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto,*" Margin="5">
                                    <!-- 启用/禁用复选框 -->
                                    <CheckBox Grid.Column="0"
                                              IsChecked="{Binding IsEnabled}"
                                              VerticalAlignment="Center"
                                              Margin="0,0,8,0"
                                              ToolTip.Tip="启用/禁用此翻译源" />

                                    <!-- 翻译源信息 -->
                                    <StackPanel Grid.Column="1" Spacing="4">
                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" />
                                        <TextBlock Text="{Binding BaseUrl}" FontSize="11" Opacity="0.7" />
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="{Binding Model}" FontSize="11" Opacity="0.6" />
                                            <TextBlock Text="✓ 已启用"
                                                       FontSize="11"
                                                       Foreground="#4CAF50"
                                                       IsVisible="{Binding IsEnabled}" />
                                            <TextBlock Text="✗ 已禁用"
                                                       FontSize="11"
                                                       Foreground="#9E9E9E"
                                                       IsVisible="{Binding !IsEnabled}" />
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- 右侧按钮和详情 -->
                    <StackPanel Grid.Column="1" Spacing="10" Width="250">
                        <Button Content="添加翻译源"
                                Command="{Binding AddProviderCommand}"
                                HorizontalAlignment="Stretch" />
                        <Button Content="删除"
                                Command="{Binding DeleteProviderCommand}"
                                IsEnabled="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}"
                                HorizontalAlignment="Stretch" />
                        <Button Content="上移"
                                Command="{Binding MoveProviderUpCommand}"
                                IsEnabled="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}"
                                HorizontalAlignment="Stretch" />
                        <Button Content="下移"
                                Command="{Binding MoveProviderDownCommand}"
                                IsEnabled="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}"
                                HorizontalAlignment="Stretch" />

                        <Separator Margin="0,10" />

                        <!-- 翻译源详情编辑 -->
                        <ScrollViewer MaxHeight="300">
                            <StackPanel Spacing="8"
                                        IsVisible="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <TextBlock Text="翻译源详情" FontWeight="Bold" />

                                <!-- 启用/禁用 -->
                                <CheckBox Content="启用此翻译源"
                                          IsChecked="{Binding SelectedProvider.IsEnabled}"
                                          FontWeight="SemiBold"
                                          Margin="0,4" />

                                <Separator />

                                <TextBlock Text="名称" />
                                <TextBox Text="{Binding SelectedProvider.Name}" Watermark="翻译源名称" />

                                <TextBlock Text="Base URL" />
                                <TextBox Text="{Binding SelectedProvider.BaseUrl}" Watermark="https://api.openai.com" />

                                <TextBlock Text="API Key" />
                                <TextBox Text="{Binding SelectedProvider.ApiKey}"
                                         Watermark="输入 API Key"
                                         PasswordChar="●" />

                                <TextBlock Text="Model" />

                                <!-- 模型选择区域 -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <!-- 模型下拉选择 -->
                                    <ComboBox Grid.Column="0"
                                              ItemsSource="{Binding SelectedProvider.AvailableModels}"
                                              SelectedItem="{Binding SelectedModelInfo}"
                                              DisplayMemberBinding="{Binding Id}"
                                              IsEnabled="{Binding !IsLoadingModels}"
                                              IsEditable="{Binding SelectedProvider.AllowManualModelInput}"
                                              PlaceholderText="选择模型或手动输入"
                                              Margin="0,0,4,0">
                                    </ComboBox>

                                    <!-- 刷新按钮 -->
                                    <Button Grid.Column="1"
                                            Content="🔄"
                                            Command="{Binding RefreshModelsCommand}"
                                            CommandParameter="{Binding SelectedProvider}"
                                            ToolTip.Tip="刷新模型列表"
                                            IsEnabled="{Binding !IsLoadingModels}"
                                            Width="40" />
                                </Grid>

                                <!-- 加载状态 -->
                                <Border Background="#FFF3E0"
                                        Padding="8"
                                        CornerRadius="4"
                                        IsVisible="{Binding IsLoadingModels}"
                                        Margin="0,4,0,0">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="⏳" FontSize="14" />
                                        <TextBlock Text="正在获取模型列表..."
                                                   VerticalAlignment="Center"
                                                   FontSize="12" />
                                    </StackPanel>
                                </Border>

                                <!-- 错误提示 -->
                                <Border Background="#FFEBEE"
                                        Padding="8"
                                        CornerRadius="4"
                                        IsVisible="{Binding HasModelLoadError}"
                                        Margin="0,4,0,0">
                                    <StackPanel Spacing="4">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="⚠️" FontSize="14" />
                                            <TextBlock Text="无法获取模型列表"
                                                       VerticalAlignment="Center"
                                                       FontWeight="Bold"
                                                       FontSize="12" />
                                        </StackPanel>
                                        <TextBlock Text="{Binding ModelLoadErrorMessage}"
                                                   FontSize="11"
                                                   TextWrapping="Wrap"
                                                   Opacity="0.8" />
                                        <TextBlock Text="请检查API Key和网络连接，或手动输入"
                                                   FontSize="11"
                                                   Opacity="0.6" />
                                    </StackPanel>
                                </Border>
                                
                            </StackPanel>
                        </ScrollViewer>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- 网络代理标签页 -->
            <TabItem Header="网络代理">
                <ScrollViewer>
                    <StackPanel Spacing="16" Margin="20" MaxWidth="500" DataContext="{Binding SettingsViewModel}">
                        <!-- 启用代理 -->
                        <CheckBox Content="启用 HTTP 代理" IsChecked="{Binding ProxyEnabled}" />

                        <StackPanel Spacing="12" IsEnabled="{Binding ProxyEnabled}">
                            <!-- 使用系统代理 -->
                            <CheckBox Content="使用系统代理"
                                      IsChecked="{Binding ProxyUseSystemProxy}"
                                      ToolTip.Tip="使用操作系统配置的代理设置" />

                            <TextBlock Text="启用后将自动使用系统代理设置，无需手动配置地址和端口"
                                       FontSize="12"
                                       Opacity="0.6"
                                       TextWrapping="Wrap"
                                       IsVisible="{Binding ProxyUseSystemProxy}" />

                            <Separator IsVisible="{Binding ProxyUseSystemProxy}" />

                            <!-- 自定义代理配置区域 -->
                            <StackPanel Spacing="12" IsEnabled="{Binding !ProxyUseSystemProxy}">
                                <!-- 代理地址 -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="代理地址" FontWeight="Bold" />
                                    <TextBox Text="{Binding ProxyAddress}"
                                             Watermark="http://127.0.0.1" />
                                    <TextBlock Text="HTTP 代理服务器地址"
                                               FontSize="12"
                                               Opacity="0.6" />
                                </StackPanel>

                                <!-- 代理端口 -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="端口" FontWeight="Bold" />
                                    <NumericUpDown Value="{Binding ProxyPort}"
                                                   Minimum="1"
                                                   Maximum="65535"
                                                   Width="200"
                                                   HorizontalAlignment="Left" />
                                </StackPanel>

                                <Separator />

                                <!-- 需要认证 -->
                                <CheckBox Content="需要身份验证" IsChecked="{Binding ProxyUseAuthentication}" />

                                <StackPanel Spacing="12" IsEnabled="{Binding ProxyUseAuthentication}">
                                    <!-- 用户名 -->
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="用户名" FontWeight="Bold" />
                                        <TextBox Text="{Binding ProxyUsername}"
                                                 Watermark="代理用户名" />
                                    </StackPanel>

                                    <!-- 密码 -->
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="密码" FontWeight="Bold" />
                                        <TextBox Text="{Binding ProxyPassword}"
                                                 Watermark="代理密码"
                                                 PasswordChar="●" />
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- 关于标签页 -->
            <TabItem Header="关于">
                <views:AboutView DataContext="{Binding AboutViewModel}" />
            </TabItem>
        </TabControl>

        <!-- 底部按钮栏 -->
        <Border Grid.Row="1"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="0,1,0,0"
                Padding="15,10">
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Spacing="10"
                        DataContext="{Binding SettingsViewModel}">
                <Button Content="保存"
                        Command="{Binding SaveSettingsCommand}"
                        MinWidth="80" />
                <Button Content="应用"
                        Command="{Binding ApplySettingsCommand}"
                        MinWidth="80" />
                <Button Content="取消"
                        Command="{Binding CancelSettingsCommand}"
                        MinWidth="80" />
            </StackPanel>
        </Border>
    </Grid>
</Window>