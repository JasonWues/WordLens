<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:WordLens.ViewModels"
        xmlns:views="using:WordLens.Views"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:conv="using:WordLens.Converter"
        mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="550"
        x:Class="WordLens.Views.MainWindowView"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="WordLens - è®¾ç½®"
        Width="700" Height="550"
        MinWidth="600" MinHeight="450"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="*,Auto" Margin="0">
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <TabControl Grid.Row="0" Margin="10" x:Name="SettingsTabControl">
            <!-- å¸¸è§„è®¾ç½®æ ‡ç­¾é¡µ -->
            <TabItem Header="å¸¸è§„">
                <ScrollViewer>
                    <StackPanel Spacing="16" Margin="20" DataContext="{Binding SettingsViewModel}">
                        <!-- åº”ç”¨ç•Œé¢è¯­è¨€ -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="ç•Œé¢è¯­è¨€" FontWeight="Bold" FontSize="14" />
                            <ComboBox ItemsSource="{Binding AvailableUILanguages}"
                                      SelectedValue="{Binding UiLanguage}"
                                      SelectedValueBinding="{Binding Code}"
                                      DisplayMemberBinding="{Binding DisplayName}"
                                      Width="300"
                                      HorizontalAlignment="Left" />
                            <TextBlock Text="é€‰æ‹©åº”ç”¨ç•Œé¢æ˜¾ç¤ºè¯­è¨€ï¼ˆç¿»è¯‘è¯­è¨€è¯·åœ¨ç¿»è¯‘çª—å£ä¸­é€‰æ‹©ï¼‰"
                                       FontSize="12"
                                       Opacity="0.6" />
                        </StackPanel>

                        <Separator />

                        <!-- å¿«æ·é”®è®¾ç½® -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="å¿«æ·é”®" FontWeight="Bold" FontSize="14" />
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBox Text="{Binding HotkeyDisplay}"
                                         IsReadOnly="True"
                                         Width="200"
                                         VerticalContentAlignment="Center" />
                                <Button Content="è®¾ç½®å¿«æ·é”®"
                                        Command="{Binding StartCaptureHotkeyCommand}"
                                        CommandParameter="text"
                                        IsEnabled="{Binding !IsCapturingHotkey}"
                                        MinWidth="100" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBox Text="{Binding OcrHotkeyDisplay}"
                                         IsReadOnly="True"
                                         Width="200"
                                         VerticalContentAlignment="Center" />
                                <Button Content="è®¾ç½®OCRå¿«æ·é”®"
                                        Command="{Binding StartCaptureHotkeyCommand}"
                                        CommandParameter="ocr"
                                        IsEnabled="{Binding !IsCapturingHotkey}"
                                        MinWidth="100" />
                            </StackPanel>
                            <TextBlock IsVisible="{Binding IsCapturingHotkey}"
                                       Text="è¯·æŒ‰ä¸‹æƒ³è¦è®¾ç½®çš„å¿«æ·é”®ç»„åˆï¼ˆæŒ‰ ESC å–æ¶ˆï¼‰"
                                       FontSize="12"
                                       Foreground="Orange"
                                       FontWeight="Bold" />
                            <TextBlock IsVisible="{Binding !IsCapturingHotkey}"
                                       Text="ç‚¹å‡»æŒ‰é’®åŽæŒ‰ä¸‹æƒ³è¦è®¾ç½®çš„å¿«æ·é”®ç»„åˆ"
                                       FontSize="12"
                                       Opacity="0.6" />
                        </StackPanel>

                        <Separator />

                        <!-- æµå¼è¾“å‡ºè®¾ç½® -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="æµå¼è¾“å‡º" FontWeight="Bold" FontSize="14" />
                            
                            <CheckBox Content="å¯ç”¨æµå¼è¾“å‡ºï¼ˆå®žæ—¶æ˜¾ç¤ºç¿»è¯‘ç»“æžœï¼‰"
                                      IsChecked="{Binding StreamingEnabled}"
                                      ToolTip.Tip="å¯ç”¨åŽç¿»è¯‘å†…å®¹å°†å®žæ—¶é€æ­¥æ˜¾ç¤ºï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ" />
                            
                            <StackPanel Spacing="12"
                                        IsEnabled="{Binding StreamingEnabled}"
                                        Margin="24,8,0,0"
                                        Opacity="{Binding StreamingEnabled, Converter={x:Static conv:BoolToOpacityConverter.BoolToOpacityValueConverter}}">
                                
                                <!-- æ‰“å­—æœºæ•ˆæžœå»¶è¿Ÿ -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="æ‰“å­—æœºæ•ˆæžœå»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰" FontSize="13" />
                                    <NumericUpDown Value="{Binding TypewriterDelayMs}"
                                                   Minimum="0"
                                                   Maximum="200"
                                                   Increment="10"
                                                   Width="200"
                                                   HorizontalAlignment="Left"
                                                   ToolTip.Tip="æ¯ä¸ªå­—ç¬¦æ˜¾ç¤ºä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´" />
                                    <TextBlock Text="0 = æ— å»¶è¿Ÿï¼Œå®žæ—¶æ˜¾ç¤ºï¼›æŽ¨èå€¼ï¼š30-50æ¯«ç§’"
                                               FontSize="11"
                                               Opacity="0.6"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                                
                                <!-- æ¯æ¬¡æ˜¾ç¤ºå­—ç¬¦æ•° -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="æ¯æ¬¡æ˜¾ç¤ºå­—ç¬¦æ•°" FontSize="13" />
                                    <NumericUpDown Value="{Binding CharsPerUpdate}"
                                                   Minimum="1"
                                                   Maximum="10"
                                                   Increment="1"
                                                   Width="200"
                                                   HorizontalAlignment="Left"
                                                   ToolTip.Tip="ä¸€æ¬¡æ€§æ˜¾ç¤ºçš„å­—ç¬¦æ•°é‡" />
                                    <TextBlock Text="1 = é€å­—æ˜¾ç¤ºï¼›è¾ƒå¤§å€¼å¯åŠ å¿«æ˜¾ç¤ºé€Ÿåº¦"
                                               FontSize="11"
                                               Opacity="0.6"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                            </StackPanel>
                            
                            <TextBlock Text="æç¤ºï¼šæµå¼è¾“å‡ºå¯ä»¥è®©ç¿»è¯‘è¿‡ç¨‹æ›´åŠ æµç•…ï¼Œä½†å¦‚æžœç½‘ç»œä¸ç¨³å®šå¯ä»¥å…³é—­æ­¤åŠŸèƒ½"
                                       FontSize="11"
                                       Opacity="0.6"
                                       TextWrapping="Wrap"
                                       Margin="0,4,0,0" />
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- ç¿»è¯‘æºç®¡ç†æ ‡ç­¾é¡µ -->
            <TabItem Header="ç¿»è¯‘æº">
                <Grid ColumnDefinitions="*,Auto" Margin="10" DataContext="{Binding SettingsViewModel}">
                    <!-- å·¦ä¾§åˆ—è¡¨ -->
                    <ListBox Grid.Column="0"
                             ItemsSource="{Binding Providers}"
                             SelectedItem="{Binding SelectedProvider}"
                             Margin="0,0,10,0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto,*" Margin="5">
                                    <!-- å¯ç”¨/ç¦ç”¨å¤é€‰æ¡† -->
                                    <CheckBox Grid.Column="0"
                                              IsChecked="{Binding IsEnabled}"
                                              VerticalAlignment="Center"
                                              Margin="0,0,8,0"
                                              ToolTip.Tip="å¯ç”¨/ç¦ç”¨æ­¤ç¿»è¯‘æº" />

                                    <!-- ç¿»è¯‘æºä¿¡æ¯ -->
                                    <StackPanel Grid.Column="1" Spacing="4">
                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" />
                                        <TextBlock Text="{Binding BaseUrl}" FontSize="11" Opacity="0.7" />
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="{Binding Model}" FontSize="11" Opacity="0.6" />
                                            <TextBlock Text="âœ“ å·²å¯ç”¨"
                                                       FontSize="11"
                                                       Foreground="#4CAF50"
                                                       IsVisible="{Binding IsEnabled}" />
                                            <TextBlock Text="âœ— å·²ç¦ç”¨"
                                                       FontSize="11"
                                                       Foreground="#9E9E9E"
                                                       IsVisible="{Binding !IsEnabled}" />
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- å³ä¾§æŒ‰é’®å’Œè¯¦æƒ… -->
                    <StackPanel Grid.Column="1" Spacing="10" Width="250">
                        <Button Content="æ·»åŠ ç¿»è¯‘æº"
                                Command="{Binding AddProviderCommand}"
                                HorizontalAlignment="Stretch" />
                        <Button Content="åˆ é™¤"
                                Command="{Binding DeleteProviderCommand}"
                                IsEnabled="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}"
                                HorizontalAlignment="Stretch" />
                        <Button Content="ä¸Šç§»"
                                Command="{Binding MoveProviderUpCommand}"
                                IsEnabled="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}"
                                HorizontalAlignment="Stretch" />
                        <Button Content="ä¸‹ç§»"
                                Command="{Binding MoveProviderDownCommand}"
                                IsEnabled="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}"
                                HorizontalAlignment="Stretch" />

                        <Separator Margin="0,10" />

                        <!-- ç¿»è¯‘æºè¯¦æƒ…ç¼–è¾‘ -->
                        <ScrollViewer MaxHeight="300">
                            <StackPanel Spacing="8"
                                        IsVisible="{Binding SelectedProvider, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <TextBlock Text="ç¿»è¯‘æºè¯¦æƒ…" FontWeight="Bold" />

                                <!-- å¯ç”¨/ç¦ç”¨ -->
                                <CheckBox Content="å¯ç”¨æ­¤ç¿»è¯‘æº"
                                          IsChecked="{Binding SelectedProvider.IsEnabled}"
                                          FontWeight="SemiBold"
                                          Margin="0,4" />

                                <Separator />

                                <TextBlock Text="åç§°" />
                                <TextBox Text="{Binding SelectedProvider.Name}" Watermark="ç¿»è¯‘æºåç§°" />

                                <TextBlock Text="Base URL" />
                                <TextBox Text="{Binding SelectedProvider.BaseUrl}" Watermark="https://api.openai.com" />

                                <TextBlock Text="API Key" />
                                <TextBox Text="{Binding SelectedProvider.ApiKey}"
                                         Watermark="è¾“å…¥ API Key"
                                         PasswordChar="â—" />

                                <TextBlock Text="Model" />

                                <!-- æ¨¡åž‹é€‰æ‹©åŒºåŸŸ -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <!-- æ¨¡åž‹ä¸‹æ‹‰é€‰æ‹© -->
                                    <ComboBox Grid.Column="0"
                                              ItemsSource="{Binding SelectedProvider.AvailableModels}"
                                              SelectedItem="{Binding SelectedModelInfo}"
                                              DisplayMemberBinding="{Binding Id}"
                                              IsEnabled="{Binding !IsLoadingModels}"
                                              IsEditable="{Binding SelectedProvider.AllowManualModelInput}"
                                              PlaceholderText="é€‰æ‹©æ¨¡åž‹æˆ–æ‰‹åŠ¨è¾“å…¥"
                                              Margin="0,0,4,0">
                                    </ComboBox>

                                    <!-- åˆ·æ–°æŒ‰é’® -->
                                    <Button Grid.Column="1"
                                            Content="ðŸ”„"
                                            Command="{Binding RefreshModelsCommand}"
                                            CommandParameter="{Binding SelectedProvider}"
                                            ToolTip.Tip="åˆ·æ–°æ¨¡åž‹åˆ—è¡¨"
                                            IsEnabled="{Binding !IsLoadingModels}"
                                            Width="40" />
                                </Grid>

                                <!-- åŠ è½½çŠ¶æ€ -->
                                <Border Background="#FFF3E0"
                                        Padding="8"
                                        CornerRadius="4"
                                        IsVisible="{Binding IsLoadingModels}"
                                        Margin="0,4,0,0">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="â³" FontSize="14" />
                                        <TextBlock Text="æ­£åœ¨èŽ·å–æ¨¡åž‹åˆ—è¡¨..."
                                                   VerticalAlignment="Center"
                                                   FontSize="12" />
                                    </StackPanel>
                                </Border>

                                <!-- é”™è¯¯æç¤º -->
                                <Border Background="#FFEBEE"
                                        Padding="8"
                                        CornerRadius="4"
                                        IsVisible="{Binding HasModelLoadError}"
                                        Margin="0,4,0,0">
                                    <StackPanel Spacing="4">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="âš ï¸" FontSize="14" />
                                            <TextBlock Text="æ— æ³•èŽ·å–æ¨¡åž‹åˆ—è¡¨"
                                                       VerticalAlignment="Center"
                                                       FontWeight="Bold"
                                                       FontSize="12" />
                                        </StackPanel>
                                        <TextBlock Text="{Binding ModelLoadErrorMessage}"
                                                   FontSize="11"
                                                   TextWrapping="Wrap"
                                                   Opacity="0.8" />
                                        <TextBlock Text="è¯·æ£€æŸ¥API Keyå’Œç½‘ç»œè¿žæŽ¥ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥"
                                                   FontSize="11"
                                                   Opacity="0.6" />
                                    </StackPanel>
                                </Border>
                                
                            </StackPanel>
                        </ScrollViewer>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- ç½‘ç»œä»£ç†æ ‡ç­¾é¡µ -->
            <TabItem Header="ç½‘ç»œä»£ç†">
                <ScrollViewer>
                    <StackPanel Spacing="16" Margin="20" MaxWidth="500" DataContext="{Binding SettingsViewModel}">
                        <!-- å¯ç”¨ä»£ç† -->
                        <CheckBox Content="å¯ç”¨ HTTP ä»£ç†" IsChecked="{Binding ProxyEnabled}" />

                        <StackPanel Spacing="12" IsEnabled="{Binding ProxyEnabled}">
                            <!-- ä½¿ç”¨ç³»ç»Ÿä»£ç† -->
                            <CheckBox Content="ä½¿ç”¨ç³»ç»Ÿä»£ç†"
                                      IsChecked="{Binding ProxyUseSystemProxy}"
                                      ToolTip.Tip="ä½¿ç”¨æ“ä½œç³»ç»Ÿé…ç½®çš„ä»£ç†è®¾ç½®" />

                            <TextBlock Text="å¯ç”¨åŽå°†è‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿä»£ç†è®¾ç½®ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®åœ°å€å’Œç«¯å£"
                                       FontSize="12"
                                       Opacity="0.6"
                                       TextWrapping="Wrap"
                                       IsVisible="{Binding ProxyUseSystemProxy}" />

                            <Separator IsVisible="{Binding ProxyUseSystemProxy}" />

                            <!-- è‡ªå®šä¹‰ä»£ç†é…ç½®åŒºåŸŸ -->
                            <StackPanel Spacing="12" IsEnabled="{Binding !ProxyUseSystemProxy}">
                                <!-- ä»£ç†åœ°å€ -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="ä»£ç†åœ°å€" FontWeight="Bold" />
                                    <TextBox Text="{Binding ProxyAddress}"
                                             Watermark="http://127.0.0.1" />
                                    <TextBlock Text="HTTP ä»£ç†æœåŠ¡å™¨åœ°å€"
                                               FontSize="12"
                                               Opacity="0.6" />
                                </StackPanel>

                                <!-- ä»£ç†ç«¯å£ -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="ç«¯å£" FontWeight="Bold" />
                                    <NumericUpDown Value="{Binding ProxyPort}"
                                                   Minimum="1"
                                                   Maximum="65535"
                                                   Width="200"
                                                   HorizontalAlignment="Left" />
                                </StackPanel>

                                <Separator />

                                <!-- éœ€è¦è®¤è¯ -->
                                <CheckBox Content="éœ€è¦èº«ä»½éªŒè¯" IsChecked="{Binding ProxyUseAuthentication}" />

                                <StackPanel Spacing="12" IsEnabled="{Binding ProxyUseAuthentication}">
                                    <!-- ç”¨æˆ·å -->
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="ç”¨æˆ·å" FontWeight="Bold" />
                                        <TextBox Text="{Binding ProxyUsername}"
                                                 Watermark="ä»£ç†ç”¨æˆ·å" />
                                    </StackPanel>

                                    <!-- å¯†ç  -->
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="å¯†ç " FontWeight="Bold" />
                                        <TextBox Text="{Binding ProxyPassword}"
                                                 Watermark="ä»£ç†å¯†ç "
                                                 PasswordChar="â—" />
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- å…³äºŽæ ‡ç­¾é¡µ -->
            <TabItem Header="å…³äºŽ">
                <views:AboutView DataContext="{Binding AboutViewModel}" />
            </TabItem>
        </TabControl>

        <!-- åº•éƒ¨æŒ‰é’®æ  -->
        <Border Grid.Row="1"
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="0,1,0,0"
                Padding="15,10">
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Spacing="10"
                        DataContext="{Binding SettingsViewModel}">
                <Button Content="ä¿å­˜"
                        Command="{Binding SaveSettingsCommand}"
                        MinWidth="80" />
                <Button Content="åº”ç”¨"
                        Command="{Binding ApplySettingsCommand}"
                        MinWidth="80" />
                <Button Content="å–æ¶ˆ"
                        Command="{Binding CancelSettingsCommand}"
                        MinWidth="80" />
            </StackPanel>
        </Border>
    </Grid>
</Window>